# Copyright (c) 2023 Forschungszentrum Juelich GmbH.
# This file is part of LLview. 
#
# This is an open source software distributed under the GPLv3 license. More information see the LICENSE file at the top level.
#
# Contributions must follow the Contributor License Agreement. More information see the CONTRIBUTING.md file at the top level.
#
# Contributors:
#    Wolfgang Frings (Forschungszentrum Juelich GmbH) 

jobreport:
  tables:
  - table:
      name: joblist
      options:
        update:
          LLjobreport: update_from_other_db(jobid,tabstat,updatedjobs)
        update_trigger:
          - jobmetrics
          - jobscores
          - jobfiles
          - pdffiles_reg
          - htmlfiles_reg
          - update_info
          - joblist_stat_by_account_owner
          - joblist_stat_by_account_owner_do_update
          - jureptool_json
          - joblist_stat
          - projstat_accounted_jobs
          - projstat_to_account_jobs
          - projstat_per_project
          - projstat_per_project_aggr
        archive:
          limit: max(ts_start)-21d,max(ts)-21d
        index: jobid,lastts
      columns: 
        - { name: jobid,           type: jobid_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 'unknown' }
        - { name: ts,              type: ts_t,              LLDB_from: jobstate/queuedjobs,    LLDB_from_lastts: yes,         LL_default: -1        }
        - { name: owner,           type: owner_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 'unknown' }
        - { name: jgroup,          type: jgroup_t,          LLDB_from: jobstate/queuedjobs,    LL_default: 'unknown' }
        - { name: jstatus,         type: jstatus_t,         LLDB_from: jobstate/queuedjobs,    LL_default: 'UNKNOWN' }
        - { name: detailedstatus,  type: detailedstatus_t,  LLDB_from: jobstate/queuedjobs,    LL_default: 'UNKNOWN' }
        - { name: state,           type: jstatus_t,         LLDB_from: jobstate/queuedjobs,    LLDB_from_filter: "Running",   LL_default: 'unknown' }
        - { name: wall,            type: wall_t,            LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: wallsoft,        type: wall_t,            LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: queuedate,       type: date_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: name,            type: name_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: comment,         type: comment_t,         LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: totalcores,      type: cores_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: totaltasks,      type: tasks_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: totalgpus,       type: tasks_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: queue,           type: queue_t,           LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: dependency,      type: dependency_t,      LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: qos,             type: qos_t,             LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: command,         type: command_t,         LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: classprio,       type: prio_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: groupprio,       type: prio_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: userprio,        type: prio_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: sysprio,         type: prio_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "-" }
        - { name: favored,         type: favored_t,         LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: restart,         type: restart_t,         LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: account,         type: account_t,         LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: runtime,         type: time_t,            LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: starttime,       type: date_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: endtime,         type: date_t,            LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: numnodes,        type: tasks_t,           LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: reason,          type: comment_t,         LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: ArrayJobId,      type: jobid_t,           LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: ArrayTaskId,     type: jobid_t,           LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: waittime,        type: hour_t,            LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: timetostart,     type: hour_t,            LLDB_from: jobstate/queuedjobs,    LL_default: 0 }
        - { name: posinqueue,      type: pos_t,             LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: resid,           type: resid_t,           LLDB_from: jobstate/queuedjobs,    LML_default: "" }
        - { name: nodelist,        type: extralongstr_t,    LLDB_from: jobstate/queuedjobs/NODES,    LL_default: "" }

        - { name: mentor,          type: account_t,         LLDB_map: "lookup(accountmap/mentormap/wsaccount, project, account)", LL_default: "-none-", }
        
        - { name: firstts,         type: ts_t,              LLDB_from: jobstate/currentjobs_deferred,       LL_default: -1 }
        - { name: lastts,          type: ts_t,              LLDB_from: jobstate/currentjobs_deferred,       LL_default: -1 }
        - { name: lastupdts,       type: ts_t,              LLDB_from: jobstate/currentjobs_deferred,       LLDB_from_lastts: yes, LL_default: -1 }
        - { name: finished,        type: flag_t,            LLDB_from: jobstate/currentjobs_deferred,       LL_default: 0 }
 
        - { name: rc_lastts,       type: cnt_t,             LLDB_from: jobstep/jobspec,       LLDB_from_lastts: yes, LL_default: -1 }
        - { name: rc_startts,      type: ts_t,              LLDB_from: jobstep/jobspec,       LL_default: -1 }
        - { name: rc_endts,        type: ts_t,              LLDB_from: jobstep/jobspec,       LL_default: -1 }
        - { name: rc_wallh,        type: hour_t,            LLDB_from: jobstep/jobspec,       LL_default: 0 }
        - { name: rc_rc,           type: cnt_t,             LLDB_from: jobstep/jobspec,       LL_default: -1 }
        - { name: rc_signr,        type: cnt_t,             LLDB_from: jobstep/jobspec,       LL_default: -1 }
        - { name: rc_state,        type: jstatus_t,         LLDB_from: jobstep/jobspec,       LL_default: "-" }

        - { name: step_lastts,     type: ts_t,              LLDB_from: jobstep/stepspec,       LLDB_from_lastts: yes, LL_default: -1 }
        - { name: min_rc,          type: cnt_t,             LLDB_from: jobstep/stepspec,       LL_default: -1 }
        - { name: max_rc,          type: cnt_t,             LLDB_from: jobstep/stepspec,       LL_default: -1 }
        - { name: nsteps,          type: cnt_t,             LLDB_from: jobstep/stepspec,       LL_default: 1 }
        - { name: ts_start,        type: ts_t,              LLDB_from: jobstep/stepspec,       LL_default: -1 }
        - { name: ts_end,          type: ts_t,              LLDB_from: jobstep/stepspec,       LL_default: -1 }
        - { name: stepspec,        type: extralongstr_t,    LLDB_from: jobstep/stepspec,       LL_default: "" }

        - { name: errmsgts,        type: ts_t,              LLDB_from: joberr/joberr,          LLDB_from_lastts: yes,       LL_default: -1        }
        - { name: nummsgs,         type: tasks_t,           LLDB_from: joberr/joberr,          LL_default: 0 }
        - { name: numerrnodes,     type: tasks_t,           LLDB_from: joberr/joberr/numnodes, LL_default: 0 }
        - { name: errmsgnodes,     type: extralongstr_t,    LLDB_from: joberr/joberr,          LL_default: "" }
        - { name: errmsgs,         type: extralongstr_t,    LLDB_from: joberr/joberr,          LL_default: "" }
        
        - { name: ldlastts,        type: ts_t,              LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LLDB_from_lastts: yes, LL_default: -1    }
        - { name: ld_ndps,         type: count_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: 0 }
        - { name: istatus_avg,     type: istatus_t,         LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: istatus_min,     type: istatus_t,         LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: istatus_max,     type: istatus_t,         LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: load_avg,        type: load_t,            LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: load_min,        type: load_t,            LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: load_max,        type: load_t,            LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: usage_avg,       type: usage_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: usage_min,       type: usage_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: usage_max,       type: usage_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_avg,  type: cores_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_min,  type: cores_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_max,  type: cores_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_phys_avg,  type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_phys_min,  type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_phys_max,  type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_logic_avg, type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_logic_min, type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_cores_logic_max, type: cores_t,      LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: total_cores_avg, type: cores_t,           LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }
        - { name: used_mem_avg,    type: mem_t,             LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: used_mem_min,    type: mem_t,             LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: used_mem_max,    type: mem_t,             LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: total_mem_avg,   type: mem_t,             LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: currentwatts_avg, type: float_t,          LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: currentwatts_min, type: float_t,          LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: currentwatts_max, type: float_t,          LLDB_from: loadmemstate/loadmem_aggr_by_jobid, LL_default: -1 }  
        - { name: cores_lastts,     type: ts_t,             LLDB_from: pcpucoresstate/pcpucores_aggr_jobid_avg, LLDB_from_lastts: yes, LL_default: -1    }
        - { name: cores_ndps,       type: count_t,          LLDB_from: pcpucoresstate/pcpucores_aggr_jobid_avg, LL_default: 0 }
       
        - { name: falastts,        type: ts_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LLDB_from_lastts: yes, LL_default: -1 }
        - { name: fa_ndps,         type: count_t,           LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbin_avg,        type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbin_min,        type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbin_max,        type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbout_avg,       type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbout_min,       type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: mbout_max,       type: mb_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckin_avg,       type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckin_min,       type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckin_max,       type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckout_avg,      type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckout_min,      type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }
        - { name: pckout_max,      type: pck_t,             LLDB_from: fabricstate/fabric_aggr_by_jobid,   LL_default: 0 }

        - { name: icmaplastts,     type: ts_t,              LLDB_from: fabricstate/fabric_aggr_by_jobid_icmap,   LLDB_from_lastts: yes, LL_default: -1 }
        - { name: icgroupmap,      type: extralongstr_t,    LLDB_from: fabricstate/fabric_aggr_by_jobid_icmap,   LL_default: "-" }

        - { name: fs_all_fslastts,       type: ts_t,        LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/fslastts, LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: fs_all_ndps,           type: count_t,     LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/fs_ndps,   LL_default: 0 }
        - { name: fs_all_MbwR_avg,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbwR_avg,  LL_default: 0 }
        - { name: fs_all_MbwR_min,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbwR_min,  LL_default: 0 }
        - { name: fs_all_MbwR_max,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbwR_max,  LL_default: 0 }
        - { name: fs_all_Mbw_sum,        type: mb_t,        LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/Mbw_sum,   LL_default: 0 }
        - { name: fs_all_MbrR_avg,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbrR_avg,  LL_default: 0 }
        - { name: fs_all_MbrR_min,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbrR_min,  LL_default: 0 }
        - { name: fs_all_MbrR_max,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/MbrR_max,  LL_default: 0 }
        - { name: fs_all_Mbr_sum,        type: mb_t,        LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/Mbr_sum,   LL_default: 0 }
        - { name: fs_all_ocR_avg,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/ocR_avg, LL_default: 0 }
        - { name: fs_all_ocR_min,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/ocR_min, LL_default: 0 }
        - { name: fs_all_ocR_max,       type: rate_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/ocR_max, LL_default: 0 }
        - { name: fs_all_Moc_sum,        type: Mops_t,      LLDB_from: fsusagestate_all/fsusage_aggr_by_jobid/Moc_sum,  LL_default: 0 }

        - { name: fs_project_fslastts,        type: ts_t,      LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/fslastts, LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: fs_project_ndps,            type: count_t,   LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/fs_ndps,   LL_default: 0 }
        - { name: fs_project_MbwR_avg,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbwR_avg,  LL_default: 0  }
        - { name: fs_project_MbwR_min,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbwR_min,  LL_default: 0 }
        - { name: fs_project_MbwR_max,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbwR_max,  LL_default: 0 }
        - { name: fs_project_Mbw_sum,         type: mb_t,      LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/Mbw_sum,   LL_default: 0 }
        - { name: fs_project_MbrR_avg,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbrR_avg,  LL_default: 0 }
        - { name: fs_project_MbrR_min,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbrR_min,  LL_default: 0 }
        - { name: fs_project_MbrR_max,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/MbrR_max,  LL_default: 0 }
        - { name: fs_project_Mbr_sum,         type: mb_t,      LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/Mbr_sum,   LL_default: 0 }
        - { name: fs_project_ocR_avg,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/ocR_avg, LL_default: 0 }
        - { name: fs_project_ocR_min,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/ocR_min, LL_default: 0 }
        - { name: fs_project_ocR_max,        type: rate_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/ocR_max, LL_default: 0 }
        - { name: fs_project_Moc_sum,         type: Mops_t,    LLDB_from: fsusagestate_project/fsusage_aggr_by_jobid/Moc_sum,  LL_default: 0 }

        - { name: fs_scratch_fslastts,        type: ts_t,      LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/fslastts, LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: fs_scratch_ndps,            type: count_t,   LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/fs_ndps,   LL_default: 0 }
        - { name: fs_scratch_MbwR_avg,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbwR_avg,  LL_default: 0  }
        - { name: fs_scratch_MbwR_min,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbwR_min,  LL_default: 0 }
        - { name: fs_scratch_MbwR_max,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbwR_max,  LL_default: 0 }
        - { name: fs_scratch_Mbw_sum,         type: mb_t,      LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/Mbw_sum,   LL_default: 0 }
        - { name: fs_scratch_MbrR_avg,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbrR_avg,  LL_default: 0 }
        - { name: fs_scratch_MbrR_min,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbrR_min,  LL_default: 0 }
        - { name: fs_scratch_MbrR_max,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/MbrR_max,  LL_default: 0 }
        - { name: fs_scratch_Mbr_sum,         type: mb_t,      LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/Mbr_sum,   LL_default: 0 }
        - { name: fs_scratch_ocR_avg,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/ocR_avg, LL_default: 0 }
        - { name: fs_scratch_ocR_min,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/ocR_min, LL_default: 0 }
        - { name: fs_scratch_ocR_max,        type: rate_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/ocR_max, LL_default: 0 }
        - { name: fs_scratch_Moc_sum,         type: Mops_t,    LLDB_from: fsusagestate_scratch/fsusage_aggr_by_jobid/Moc_sum,  LL_default: 0 }

        - { name: fs_home_fslastts,        type: ts_t,      LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/fslastts, LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: fs_home_ndps,            type: count_t,   LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/fs_ndps,   LL_default: 0 }
        - { name: fs_home_MbwR_avg,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbwR_avg,  LL_default: 0  }
        - { name: fs_home_MbwR_min,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbwR_min,  LL_default: 0 }
        - { name: fs_home_MbwR_max,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbwR_max,  LL_default: 0 }
        - { name: fs_home_Mbw_sum,         type: mb_t,      LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/Mbw_sum,   LL_default: 0 }
        - { name: fs_home_MbrR_avg,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbrR_avg,  LL_default: 0 }
        - { name: fs_home_MbrR_min,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbrR_min,  LL_default: 0 }
        - { name: fs_home_MbrR_max,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/MbrR_max,  LL_default: 0 }
        - { name: fs_home_Mbr_sum,         type: mb_t,      LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/Mbr_sum,   LL_default: 0 }
        - { name: fs_home_ocR_avg,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/ocR_avg, LL_default: 0 }
        - { name: fs_home_ocR_min,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/ocR_min, LL_default: 0 }
        - { name: fs_home_ocR_max,        type: rate_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/ocR_max, LL_default: 0 }
        - { name: fs_home_Moc_sum,         type: Mops_t,    LLDB_from: fsusagestate_home/fsusage_aggr_by_jobid/Moc_sum,  LL_default: 0 }

        - { name: fs_fastdata_fslastts,        type: ts_t,      LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/fslastts, LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: fs_fastdata_ndps,            type: count_t,   LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/fs_ndps,   LL_default: 0 }
        - { name: fs_fastdata_MbwR_avg,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbwR_avg,  LL_default: 0  }
        - { name: fs_fastdata_MbwR_min,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbwR_min,  LL_default: 0 }
        - { name: fs_fastdata_MbwR_max,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbwR_max,  LL_default: 0 }
        - { name: fs_fastdata_Mbw_sum,         type: mb_t,      LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/Mbw_sum,   LL_default: 0 }
        - { name: fs_fastdata_MbrR_avg,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbrR_avg,  LL_default: 0 }
        - { name: fs_fastdata_MbrR_min,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbrR_min,  LL_default: 0 }
        - { name: fs_fastdata_MbrR_max,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/MbrR_max,  LL_default: 0 }
        - { name: fs_fastdata_Mbr_sum,         type: mb_t,      LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/Mbr_sum,   LL_default: 0 }
        - { name: fs_fastdata_ocR_avg,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/ocR_avg, LL_default: 0 }
        - { name: fs_fastdata_ocR_min,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/ocR_min, LL_default: 0 }
        - { name: fs_fastdata_ocR_max,        type: rate_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/ocR_max, LL_default: 0 }
        - { name: fs_fastdata_Moc_sum,         type: Mops_t,    LLDB_from: fsusagestate_fastdata/fsusage_aggr_by_jobid/Moc_sum,  LL_default: 0 }

        - { name: gpulastts,       type: ts_t,              LLDB_from: gpustate/gpu_aggr_by_jobid,   LLDB_from_lastts: yes,   LL_default: -1    }
        - { name: gpu_ndps,        type: count_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0 }
        - { name: gpu_numgpus,     type: count_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0 }
        - { name: gpu_istatus_avg, type: istatus_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0 }
        - { name: gpu_istatus_min, type: istatus_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_istatus_max, type: istatus_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_eadm_d_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  } 
        - { name: gpu_eadm_s_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_eaom_d_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_eaom_s_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_evdm_d_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_evdm_s_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_evom_d_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_evom_s_sum,  type: errcnt_t,          LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clk_avg,     type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clk_min,     type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clk_max,     type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clkr_avg,    type: clkr_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clkr_min,    type: clkr_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_clkr_max,    type: clkr_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_link_avg,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_link_min,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_link_max,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memf_avg,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memf_min,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memf_max,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memt_avg,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memt_min,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memt_max,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memu_avg,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memu_min,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memu_max,    type: mem_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memur_avg,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memur_min,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_memur_max,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pciw_avg,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pciw_min,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pciw_max,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pfst_avg,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pfst_min,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pfst_max,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pu_avg,      type: power_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pu_min,      type: power_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pu_max,      type: power_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_d_avg,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_d_min,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_d_max,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_s_avg,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_s_min,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtp_s_max,   type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtpd_avg,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtpd_min,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_rtpd_max,    type: num_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_sclk_avg,    type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_sclk_min,    type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_sclk_max,    type: clk_t,             LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_temp_avg,    type: temp_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_temp_min,    type: temp_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_temp_max,    type: temp_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_usage_avg,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_usage_min,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_usage_max,   type: rate_t,            LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_tx_avg, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_tx_min, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_tx_max, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_rx_avg, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_rx_min, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_pcie_rx_max, type: bytes_t,           LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_tx_avg, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_tx_min, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_tx_max, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_rx_avg, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_rx_min, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpu_nvlink_rx_max, type: bytes_t,         LLDB_from: gpustate/gpu_aggr_by_jobid,   LL_default: 0  }
        - { name: gpulist,         type: extralongstr_t,    LLDB_from: gpustate/currentjobs_gpulist, LL_default: "" }
        - { name: gpuspec,         type: extralongstr_t,    LLDB_from: gpustate/currentjobs_gpuspec, LL_default: "" }
        - { name: gpu_node_up_avg,  type: cnt_f_t,          LLDB_from: gpustate/gpu_aggr_by_jobid/node_up_avg,   LL_default: 0  }
        - { name: gpu_node_up_min,  type: cnt_t,            LLDB_from: gpustate/gpu_aggr_by_jobid/node_up_min,   LL_default: 0  }
        - { name: gpu_node_up_max,  type: cnt_t,            LLDB_from: gpustate/gpu_aggr_by_jobid/node_up_max,   LL_default: 0  }
        - { name: gpu_dcgm_up_avg,  type: cnt_f_t,          LLDB_from: gpustate/gpu_aggr_by_jobid/dcgm_up_avg,   LL_default: 0  }
        - { name: gpu_dcgm_up_min,  type: cnt_t,            LLDB_from: gpustate/gpu_aggr_by_jobid/dcgm_up_min,   LL_default: 0  }
        - { name: gpu_dcgm_up_max, type: cnt_t,             LLDB_from: gpustate/gpu_aggr_by_jobid/dcgm_up_max,   LL_default: 0  }

        - { name: wf_id,           type: jobid_t,           LLDB_from: jobstate/queuedjobs,    LL_default: "" }
        - { name: wf_jid,          type: jobid_t,           LLDB_from: jobstate/queuedjobs,    LL_default: "" }
       
        - { name: jmc_ts,          type: ts_t,              LLDB_from: jumoncstate/jumonc_desc_by_jobid/ts,       LLDB_from_lastts: yes,       LL_default: -1        }
        - { name: jmc_numvars,     type: count_t,           LLDB_from: jumoncstate/jumonc_desc_by_jobid/numvars,  LL_default: 0 }
        - { name: jmc_ndps,        type: count_t,           LLDB_from: jumoncstate/jumonc_desc_by_jobid/jmc_ndps,     LL_default: 0 }
        - { name: jmc_names,       type: longstr_t,         LLDB_from: jumoncstate/jumonc_desc_by_jobid/names,        LL_default: '' }
        - { name: jmc_descs,       type: extralongstr_t,    LLDB_from: jumoncstate/jumonc_desc_by_jobid/descriptions, LL_default: '' }
        - { name: jmc_minimums,    type: longstr_t,         LLDB_from: jumoncstate/jumonc_desc_by_jobid/minimums,     LL_default: '' }
        - { name: jmc_maximums,    type: longstr_t,         LLDB_from: jumoncstate/jumonc_desc_by_jobid/maximums,     LL_default: '' }
        
  - table:
      name: jobscores
      options:
        update:
          sql_update_contents:
            sql: DELETE FROM jobscores WHERE jobid IN (select jobid from updatedjobs);
                 INSERT INTO jobscores (jobid,ldscore, cpuscore,
                                        fs_all_w_score,fs_all_r_score,
                                        fs_home_w_score,fs_home_r_score,
                                        fs_project_w_score,fs_project_r_score,
                                        fs_scratch_w_score,fs_scratch_r_score,
                                        fs_fastdata_w_score,fs_fastdata_r_score,
                                        gpu_usage_score,total_score,rc_state_color)
                      SELECT jobid,
                      
                             CASE
                               WHEN (load_avg<0.5*total_cores_avg) THEN ROUND(MIN(load_avg/(0.5*total_cores_avg),1.0), 2)
                               ELSE 1.0
                             END AS ldscore,
                             
                             ROUND(MIN(usage_avg,1.0), 2) AS cpuscore,
                             
                             CASE
                               WHEN ( fs_all_MbwR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_all_Mbw_sum  < 1.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_all_Mbw_sum / (1024.0*1024) , 1.0 ), 2)
                             END AS fs_all_w_score,
                             CASE
                               WHEN ( fs_all_MbrR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_all_Mbr_sum  < 1.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_all_Mbr_sum / (1024.0*1024) , 1.0 ), 2)
                             END AS fs_all_r_score,
                             
                             CASE
                               WHEN ( fs_home_MbwR_max > 1.0*1024 ) THEN 0.0
                               WHEN ( fs_home_Mbw_sum  < 1.0*1024 ) THEN 0.5
                               ELSE ROUND(MAX( 0.5 - 0.5 * fs_home_Mbw_sum / (1024.0*1024) , 0.0 ), 2)
                             END AS fs_home_w_score,
                             CASE
                               WHEN ( fs_home_MbrR_max > 1.0*1024 ) THEN 0.0
                               WHEN ( fs_home_Mbr_sum  < 1.0*1024 ) THEN 0.5
                               ELSE ROUND(MAX( 0.5 - 0.5 * fs_home_Mbr_sum / (1024.0*1024) , 0.0 ), 2)
                             END AS fs_home_r_score,

                             CASE
                               WHEN ( fs_project_MbwR_max > 50.0*1024 ) THEN 1.0
                               WHEN ( fs_project_Mbw_sum  < 16.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_project_Mbw_sum / (256.0*1024) , 1.0 ), 2)
                             END AS fs_project_w_score,
                             CASE
                               WHEN ( fs_project_MbrR_max > 50.0*1024 ) THEN 1.0
                               WHEN ( fs_project_Mbr_sum  < 16.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_project_Mbr_sum / (256.0*1024) , 1.0 ), 2)
                             END AS fs_project_r_score,

                             CASE
                               WHEN ( fs_scratch_MbwR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_scratch_Mbw_sum  < 512.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_scratch_Mbw_sum / (512.0*1024) , 1.0 ), 2)
                             END AS fs_scratch_w_score,
                             CASE
                               WHEN ( fs_scratch_MbrR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_scratch_Mbr_sum  < 512.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_scratch_Mbr_sum / (512.0*1024) , 1.0 ), 2)
                             END AS fs_scratch_r_score,

                             CASE
                               WHEN ( fs_fastdata_MbwR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_fastdata_Mbw_sum  < 512.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_fastdata_Mbw_sum / (512.0*1024) , 1.0 ), 2)
                             END AS fs_fastdata_w_score,
                             CASE
                               WHEN ( fs_fastdata_MbrR_max > 200.0*1024 ) THEN 1.0
                               WHEN ( fs_fastdata_Mbr_sum  < 512.0*1024 )   THEN 0.5
                               ELSE ROUND(MIN( 0.5 + 0.5 * fs_fastdata_Mbr_sum / (512.0*1024) , 1.0 ), 2)
                             END AS fs_fastdata_r_score,

                             CASE
                             WHEN (gpu_numgpus>0) THEN ROUND(MIN(gpu_usage_avg/100.0,1.0), 2)
                             ELSE 0.5
                             END AS gpu_usage_score,

                             CASE
                               WHEN (gpu_numgpus>0) AND (load_avg<0.5*total_cores_avg) THEN ROUND(0.97*MIN(gpu_usage_avg/100.0,1.0) + 0.03*load_avg/(0.5*total_cores_avg), 2)
                               WHEN (gpu_numgpus>0) AND (load_avg>=0.5*total_cores_avg) THEN ROUND(0.97*MIN(gpu_usage_avg/100.0,1.0) + 0.03, 2)
                               WHEN (load_avg<0.5*total_cores_avg) THEN ROUND(MIN(load_avg/(0.5*total_cores_avg),1.0), 2)
                               ELSE 1.0
                             END AS total_score,

                             CASE
                               WHEN ( rc_state = "-" OR rc_state = "RUNNING" ) THEN "blue"
                               WHEN ( rc_state = "FAILED" ) THEN "red"
                               WHEN ( rc_state = "COMPLETED" ) THEN "#008000"
                               ELSE "#daa621"
                             END AS rc_state_color

                             FROM joblist
                             WHERE jobid IN (select jobid from updatedjobs);
                            # If cpu_usage is available, this is a better score
                            #  CASE
                            #    WHEN (gpu_numgpus>0) AND (usage_avg<1.0) THEN ROUND(0.97*MIN(gpu_usage_avg/100.0,1.0) + 0.03*usage_avg, 2)
                            #    WHEN (gpu_numgpus>0) AND (usage_avg>=1.0) THEN ROUND(0.97*MIN(gpu_usage_avg/100.0,1.0) + 0.03, 2)
                            #    WHEN (usage_avg<1.0) THEN ROUND(MIN(usage_avg,1.0), 2)
                            #    ELSE 1.0
                            #  END AS total_score,
        archive:
            non_existent: joblist/jobid
        index: jobid
      columns: 
          - { name: jobid,                 type: jobid_t,    LL_default: 'unknown' }
          - { name: ldscore,               type: score_t,    LL_default: 0 }
          - { name: cpuscore,              type: score_t,    LL_default: 0 }
          - { name: fs_all_w_score,        type: score_t,    LL_default: 0 }
          - { name: fs_all_r_score,        type: score_t,    LL_default: 0 }
          - { name: fs_home_w_score,       type: score_t,    LL_default: 0 }
          - { name: fs_home_r_score,       type: score_t,    LL_default: 0 }
          - { name: fs_project_w_score,    type: score_t,    LL_default: 0 }
          - { name: fs_project_r_score,    type: score_t,    LL_default: 0 }
          - { name: fs_scratch_w_score,    type: score_t,    LL_default: 0 }
          - { name: fs_scratch_r_score,    type: score_t,    LL_default: 0 }
          - { name: fs_fastdata_w_score,   type: score_t,    LL_default: 0 }
          - { name: fs_fastdata_r_score,   type: score_t,    LL_default: 0 }
          - { name: gpu_usage_score,       type: score_t,    LL_default: 0 }
          - { name: total_score,           type: score_t,    LL_default: 0 }
          - { name: rc_state_color,        type: shortstr_t, LL_default: "" }
 
  - table:
      name: jobmetrics
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM jobmetrics WHERE jobid IN (select jobid from updatedjobs);
                 INSERT INTO jobmetrics (jobid,mbinout_avg,pckinout_avg,
                                         runtimeperc)
                      SELECT jobid,
                             mbin_avg+mbout_avg,pckin_avg+pckout_avg,
                             CASE WHEN ( wall > 0 ) THEN 100.0*runtime/wall
                                  ELSE 0
                             END runtimeperc
                             FROM joblist
                             WHERE jobid IN (select jobid from updatedjobs);
        archive:
            non_existent: joblist/jobid
        index: jobid
      columns: 
          - { name: jobid,         type: jobid_t, LL_default: 'unknown' }
          - { name: mbinout_avg,   type: mb_t,    LL_default: -1 }
          - { name: pckinout_avg,  type: pck_t,   LL_default: -1 }
          - { name: runtimeperc,   type: perc_t,  LL_default: 0 }

  - table:
      name: jobfiles
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM jobfiles WHERE jobid IN (select jobid from updatedjobs);
                 INSERT INTO jobfiles (jobid,loadmemnodefile,coreusagenodefile,gpunodefile,fabricnodefile,
                                       fsallnodefile,fsprojectnodefile,fsscratchnodefile,fsfastdatanodefile,fshomenodefile,
                                       jmcfile,pdffile,htmlfile)
                      SELECT jobid,
                             CASE
                               WHEN (ld_ndps>0) THEN "LoadMem_"||jobid||"_node.dat"
                               ELSE "-"
                             END,
                             CASE
                               WHEN (cores_ndps>0) THEN "PCOREusage_"||jobid||"_node.dat"
                               ELSE "-"
                             END,
                             CASE
                               WHEN (gpu_ndps>0) THEN "GPU_"||jobid||"_node.dat"
                               ELSE "-"
                             END,
                             CASE
                               WHEN (fa_ndps>0) THEN "Fabric_"||jobid||"_node.dat"
                               ELSE "-"
                             END ,
                             CASE
                               WHEN (fs_all_ndps>0) THEN "FSusage_"||jobid||"_all_node.dat"
                               ELSE "-"
                             END ,
                             CASE
                               WHEN (fs_project_ndps>0) THEN "FSusage_"||jobid||"_project_node.dat"
                               ELSE "-"
                             END ,
                             CASE
                               WHEN (fs_scratch_ndps>0) THEN "FSusage_"||jobid||"_scratch_node.dat"
                               ELSE "-"
                             END ,
                             CASE
                               WHEN (fs_fastdata_ndps>0) THEN "FSusage_"||jobid||"_fastdata_node.dat"
                               ELSE "-"
                             END,
                             CASE
                               WHEN (fs_home_ndps>0) THEN "FSusage_"||jobid||"_home_node.dat"
                               ELSE "-"
                             END,
                             CASE
                               WHEN (jmc_ndps>0) THEN "JuMonC_"||jobid||".dat"
                               ELSE "-"
                             END,
                             "jobreport_"||"SYSTEMNAME"||"_"||account||"_"||owner||"_"||jobid||".pdf",
                             "jobreport_"||"SYSTEMNAME"||"_"||account||"_"||owner||"_"||jobid||".html"
                             FROM joblist
                             WHERE jobid IN (select jobid from updatedjobs);
        index: jobid
        archive:
            non_existent: joblist/jobid
      columns: 
          - { name: jobid,               type: jobid_t,    LL_default: 'unknown' }
          - { name: loadmemnodefile,     type: filename_t, LL_default: '-' }
          - { name: coreusagenodefile,   type: filename_t, LL_default: '-' }
          - { name: gpunodefile,         type: filename_t, LL_default: '-' }
          - { name: fabricnodefile,      type: filename_t, LL_default: '-' }
          - { name: fsallnodefile,       type: filename_t, LL_default: '-' }
          - { name: fsprojectnodefile,   type: filename_t, LL_default: '-' }
          - { name: fsscratchnodefile,   type: filename_t, LL_default: '-' }
          - { name: fsfastdatanodefile,  type: filename_t, LL_default: '-' }
          - { name: fshomenodefile,      type: filename_t, LL_default: '-' }
          - { name: jmcfile,             type: filename_t, LL_default: '-' }
          - { name: pdffile,             type: filename_t, LL_default: '-' }
          - { name: htmlfile,            type: filename_t, LL_default: '-' }

  - table:
      name: pdffiles_reg
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM pdffiles_reg WHERE jobid IN (select jobid from updatedjobs);
                 INSERT INTO pdffiles_reg (jobid,pdffile_reg)
                    SELECT jobid,
                           CASE
                             WHEN (status=1) THEN pdffile
                             ELSE "-"
                           END
                    FROM jobfiles LEFT OUTER JOIN datasetstat_job_jureptool_pdf
                    ON jobid=ukey 
                    WHERE jobid IN (select jobid from updatedjobs); 
        archive:
            non_existent: joblist/jobid
        index: jobid
      columns: 
          - { name: jobid,               type: jobid_t,    LL_default: 'unknown' }
          - { name: pdffile_reg,         type: filename_t, LL_default: '-' }

# Fill table: insert into pdffiles_reg (jobid,pdffile_reg) select jobid,"-" from jobfiles where (jobid not in (select jobid from pdffiles_reg));
          
  - table:
      name: htmlfiles_reg
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM htmlfiles_reg WHERE jobid IN (select jobid from updatedjobs);
                 INSERT INTO htmlfiles_reg (jobid,htmlfile_reg)
                    SELECT jobid,
                           CASE
                             WHEN (status=1) THEN htmlfile
                             ELSE "-"
                           END
                    FROM jobfiles LEFT OUTER JOIN datasetstat_job_jureptool_html
                    ON jobid=ukey 
                    WHERE jobid IN (select jobid from updatedjobs); 
        index: jobid
        archive:
            non_existent: joblist/jobid
      columns: 
          - { name: jobid,               type: jobid_t,    LL_default: 'unknown' }
          - { name: htmlfile_reg,         type: filename_t, LL_default: '-' }

  - table:
      name: jureptool_json
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM jureptool_json;
                 INSERT INTO jureptool_json (ts,account,owner,jobid,est_work_score,jsonfile)
                    SELECT ts,account,owner,jobid,
                           (numnodes*ld_ndps)+(gpu_numgpus*gpu_ndps),
                           "projects/"||account||"/"||owner||"/jobreport_"||account||"_"||owner||"_"||jobid||".json"
                    FROM joblist
                    WHERE jobid IN (SELECT jobid FROM updatedjobs) AND (ts>0) AND (owner!="unknown") AND (owner!='root') AND (owner!='deepest-admin')
      columns: 
          - { name: ts,             type: ts_t }
          - { name: jobid,          type: jobid_t }
          - { name: account,        type: account_t }
          - { name: owner,          type: owner_t }
          - { name: est_work_score, type: score_t }
          - { name: jsonfile,       type: filename_t }
          
          
  - table:
      name: datasetstat_job_jureptool_pdf
      %include "./databases/jobreport_databases_stat_tables.yaml"

  - table:
      name: datasetstat_job_jureptool_html
      %include "./databases/jobreport_databases_stat_tables.yaml"

          
  - table:
      name: tabstat
      options:
      columns: 
        - { name: tabspec,         type: name_t,  LL_default: 'unknown' }
        - { name: lasttscol,       type: name_t,  LL_default: 'unknown' }
        - { name: lastts,          type: ts_t,    LL_default: -1        }

  - table:
      name: updatedjobs
      options:
      columns: 
        - { name: jobid,           type: jobid_t, LL_default: 'unknown' }

  - table:
      name: updatedjobs_last
      options:
          sql_update_contents:
            sqldebug: 1
            sql: DELETE FROM updatedjobs_last;
                 INSERT INTO updatedjobs_last (jobid) SELECT jobid FROM updatedjobs;
      columns: 
        - { name: jobid,           type: jobid_t }

  - table:
      name: finishedjobs
      options:
        update:
          sql_update_contents:
            sqldebug: 1
            sql: DELETE FROM finishedjobs;
                 INSERT INTO finishedjobs (jobid, account, owner, mentor) 
                   SELECT jobid, account, owner, mentor FROM joblist
                   WHERE jobid IN (SELECT jobid FROM updatedjobs_last
                                   WHERE (jobid not in (SELECT jobid FROM updatedjobs) ) )
                        AND (owner!="unknown");
      columns: 
        - { name: jobid,           type: jobid_t }
        - { name: account,         type: account_t }
        - { name: owner,           type: owner_t }
        - { name: mentor,          type: account_t }

  - table:
      name: dirstat
      options:
      columns: 
        - { name: dir,             type: longstr_t,  LL_default: 'unknown' }
        - { name: lastts_req,      type: ts_t,       LL_default: -1        }
        - { name: lastts_chk,      type: ts_t,       LL_default: -1        }
        - { name: status,          type: istatus_t,  LL_default: -1 }   # 0 -> not exists, 1 -> exists, -1 unknown

  - table:
      name: update_info
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM update_info WHERE (id=1);
                 INSERT INTO update_info (id,ts,duration)
                   SELECT 1,ts,0 FROM update_info WHERE (id=0);
                 DELETE FROM update_info WHERE (id=0);
                 INSERT INTO update_info (id,ts,duration) VALUES(0,TS_NOW,0);
                 DELETE FROM update_info WHERE (id=2);
                 INSERT INTO update_info (id,ts,duration,Last_Database_update)
                   SELECT 2,0,
                          TS_NOW-ts,
                          "DATE_NOW"||" (took "||round(TS_NOW-ts,2)||" sec since previous update)"
                   FROM update_info WHERE (id=1);
                 
      columns: 
        - { name: id,              type: cnt_t,      LL_default: 0   }
        - { name: ts,              type: ts_t,       LL_default: -1  }
        - { name: duration,        type: ts_t,       LL_default: -1  }
        - { name: Last_Database_update, type: longstr_t,  LL_default: "-"  }
        

  - table:
      name: update_last
      options:
      columns: 
        - { name: id,              type: cnt_t,      LL_default: 0  }
        - { name: ts,              type: ts_t,       LL_default: -1 }

  - table:
      name: joblist_stat_by_account_owner
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM joblist_stat_by_account_owner WHERE (type=1);
                 INSERT INTO joblist_stat_by_account_owner (type,timeframe,account,owner,checksum)
                    SELECT 1,timeframe,account,owner,checksum FROM joblist_stat_by_account_owner WHERE (type=0);
                 DELETE FROM joblist_stat_by_account_owner WHERE (type=0);
                 INSERT INTO joblist_stat_by_account_owner (type,timeframe,account,owner,checksum)
                    SELECT 0,0,account,owner,sum(lastts)
                    FROM joblist WHERE (lastts>=TS_NOW-180)
                    GROUP by owner; 
                 INSERT INTO joblist_stat_by_account_owner (type,timeframe,account,owner,checksum)
                    SELECT 0,1,account,owner,sum(lastts)
                    FROM joblist WHERE (lastts>=TS_STARTOFTODAY) AND ((lastts<TS_NOW-180))
                    GROUP by owner; 
                 INSERT INTO joblist_stat_by_account_owner (type,timeframe,account,owner,checksum)
                    SELECT 0,2,account,owner,sum(lastts)
                    FROM joblist WHERE (lastts>=TS_STARTOFTODAY-21*24*3600) AND ((lastts<TS_STARTOFTODAY))
                    GROUP by owner; 
      columns: 
          - { name: type,            type: cnt_t  }
          - { name: timeframe,       type: cnt_t  }
          - { name: account,         type: account_t }
          - { name: owner,           type: owner_t }
          - { name: checksum,        type: checksum_t }

  - table:
      name: joblist_stat_by_account_owner_do_update
      options:
        update:
          sql_update_contents:
            sqldebug: 0
            sql: DELETE FROM joblist_stat_by_account_owner_do_update;
                 INSERT INTO joblist_stat_by_account_owner_do_update (account,owner,timeframe)
                    SELECT DISTINCT account,owner,timeframe FROM joblist_stat_by_account_owner
                    GROUP BY account,owner,timeframe,checksum HAVING COUNT(*)=1
      columns: 
          - { name: account,         type: account_t }
          - { name: owner,           type: owner_t }
          - { name: timeframe,       type: cnt_t  }
        
  %include "./databases/jobreport_databases_queued.yaml"
  %include "./databases/jobreport_databases_roles.yaml"
  %include "./databases/jobreport_databases_projstat.yaml"
        
jobreport_stat_loadmem:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_cpuusage:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
      
      
jobreport_stat_fabric:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_fsusage_all:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  
jobreport_stat_fsusage_project:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_fsusage_scratch:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_fsusage_fastdata:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_fsusage_home:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_gpu:
  tables:
  - table:
      name: datasetstat_node_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_all_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_jobdata:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_sysstat:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_DBstat:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_steptimings:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_transfer:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
      
jobreport_stat_roles:
  tables:
  - table:
      name: datasetstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_projstat:
  tables:
  - table:
      name: datasetstat_projstat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_stat_export:
  tables:
  - table:
      name: datasetstat_csv
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"
      
jobreport_json_stat:
  tables:
  - table:
      name: datasetstat_support
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_user_running
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_user_today
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_user_threeweeks
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_project_running
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_project_today
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_project_threeweeks
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_templates
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_job_jureptool
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_info
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_mentor_running
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_mentor_today
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_mentor_threeweeks
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_queued
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_reservations
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_sysstat
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_dbstat
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_nodeerr
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_steptimings
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_corepattern
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_heatmap
      %include "./databases/jobreport_databases_stat_tables.yaml"

jobreport_access_stat:
  tables:
  - table:
      name: datasetstat_user_access
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_project_access
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_support_access
      %include "./databases/jobreport_databases_stat_tables.yaml"
  - table:
      name: datasetstat_mentor_access
      %include "./databases/jobreport_databases_stat_tables.yaml"

      
jobreport_json_meta_stat:
  tables:
  - table:
      name: datasetstat_job_jureptool_list
      %include "./databases/jobreport_databases_stat_tables.yaml"
      
jobreport_stat_jumonc:
  tables:
  - table:
      name: datasetstat_dat
      options:
        index: ukey,lastts_saved,name
      %include "./databases/jobreport_databases_stat_tables.yaml"

# update mentor field:
# > attach database 'jurecadc/db/LLmonDB_accountmap.sqlite' as accountmap;
# > update joblist set mentor = (select wsaccount from accountmap.mentormap where account=accountmap.mentormap.project) where (select wsaccount from accountmap.mentormap where account=accountmap.mentormap.project) is not null;

      
